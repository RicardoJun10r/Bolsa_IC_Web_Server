<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Monitoramento do Servidor</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<!-- Chart.js para o gráfico -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
	<!-- Navbar -->
	<nav class="navbar navbar-expand-lg bg-secondary mb-4">
		<div class="container-fluid">
			<a class="navbar-brand" href="/">
				<img src="assets/icone_bolsa_pibic.jpeg" alt="icone" width="60" height="55">
				<span class="display-6" style="padding: 20px 20px 20px 20px;">Painel de Controle</span>
			</a>
		</div>
	</nav>

	<div class="container-fluid">
		<div class="row mb-4">
			<!-- Grid 1: Lista de servidores -->
			<div class="col-md-6" id="server-info-col">
				<h4>Servidores e Microcontroladores</h4>
				<ul class="list-group" id="server-list">
					<!-- Será populado dinamicamente -->
				</ul>
			</div>

			<!-- Grid 2: Tabela de operações -->
			<div class="col-md-6">
				<h4>Operações</h4>
				<table class="table table-striped table-hover" id="operations-table">
					<thead>
						<tr>
							<th>Num. Operação</th>
							<th>Endereço Servidor</th>
							<th>Requisição</th>
							<th>Horário</th>
						</tr>
					</thead>
					<tbody id="operations-body">
						<!-- Linhas adicionadas dinamicamente -->
					</tbody>
				</table>
			</div>
		</div>

		<div class="row">
			<!-- Grid 3: Gráfico de operações por servidor -->
			<div class="col-md-6">
				<h4>Operações por Servidor</h4>
				<canvas id="operationsChart"></canvas>
			</div>

			<!-- Grid 4: Reservado -->
			<div class="col-md-6">
				<h4>Outro painel</h4>
				<p>Espaço reservado para futuras informações.</p>
			</div>
		</div>
	</div>

	<!-- Modal para detalhes da operação -->
	<div class="modal fade" id="operationModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Detalhes da Operação</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
				</div>
				<div class="modal-body">
					<p><strong>Endereço do Servidor:</strong> <span id="modal-server-address"></span></p>
					<p><strong>Operação:</strong> <span id="modal-operation"></span></p>
					<p><strong>Data:</strong> <span id="modal-date-info"></span></p>
					<p><strong>Opção:</strong> <span id="modal-header-info"></span></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
		crossorigin="anonymous"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		// Declarações de variáveis globais
		var serverMicroMap = {};  // Mapeia endereço do servidor -> Set de microcontroladores
		var serverOpCount = {};   // Mapeia endereço do servidor -> número de operações
		var operationCount = 0;   // Contador global de operações
		var operationsBody;       // Corpo da tabela de operações
		var modalServerAddress;
		var modalOperation;
		var modalHeaderInfo;
		var modalDateInfo;
		var operationModal;

		document.addEventListener('DOMContentLoaded', function () {
			operationsBody = document.getElementById('operations-body');
			modalServerAddress = document.getElementById('modal-server-address');
			modalOperation = document.getElementById('modal-operation');
			modalHeaderInfo = document.getElementById('modal-header-info');
			modalDateInfo = document.getElementById('modal-date-info');

			// Inicializa o modal do Bootstrap
			var modalElement = document.getElementById('operationModal');
			operationModal = new bootstrap.Modal(modalElement);

			// Inicializa o gráfico
			var ctx = document.getElementById('operationsChart').getContext('2d');
			window.operationsChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: [],
					datasets: [{
						label: 'Operações',
						data: [],
						backgroundColor: 'rgba(54, 162, 235, 0.5)'
					}]
				},
				options: {}
			});
		});

		function updateServerList() {
			var serverList = document.getElementById('server-list');
			serverList.innerHTML = '';
			for (let srv in serverMicroMap) {
				const li = document.createElement('li');
				li.className = 'list-group-item';
				li.textContent = `${srv} - Microcontroladores: ${[...serverMicroMap[srv]].length}`;
				serverList.appendChild(li);
			}
		}

		function updateChart() {
			var chart = window.operationsChart;
			chart.data.labels = Object.keys(serverOpCount);
			chart.data.datasets[0].data = Object.keys(serverOpCount).map(k => serverOpCount[k]);
			chart.update();
		}

		// Inicializa o Socket.IO
		var socket = io();

		socket.on('atualizar mensagens', function (data) {
			try {
				// Parseia a mensagem como JSON
				var mensagem = JSON.parse(data.msg);

				// Verifica se os campos essenciais existem
				if (!mensagem.endereco || !mensagem.porta || !mensagem.mensagem) {
					console.error('Mensagem incompleta:', mensagem);
					return;
				}

				var serverAddress = `${mensagem.endereco}:${mensagem.porta}`;
				var operation = mensagem.mensagem;

				// Formata data e hora separadamente, se disponível
				var horario = '';
				var dataStr = '';
				if (mensagem.horario) {
					var dataHora = new Date(mensagem.horario);
					var hours = dataHora.getHours().toString().padStart(2, '0');
					var minutes = dataHora.getMinutes().toString().padStart(2, '0');
					var seconds = dataHora.getSeconds().toString().padStart(2, '0');
					var day = dataHora.getDate().toString().padStart(2, '0');
					var month = (dataHora.getMonth() + 1).toString().padStart(2, '0');
					var year = dataHora.getFullYear();

					// Apenas horário na tabela
					horario = `${hours}:${minutes}:${seconds}`;
					// Data no modal
					dataStr = `${day}/${month}/${year}`;
				}

				// Atualiza o mapa de servidores e microcontroladores
				if (!serverMicroMap[serverAddress]) {
					serverMicroMap[serverAddress] = new Set();
				}
				if (mensagem.microcontrolador_id !== undefined) {
					serverMicroMap[serverAddress].add(mensagem.microcontrolador_id);
				}
				updateServerList();

				// Incrementa o contador de operações
				operationCount++;

				// Cria linha na tabela de operações incluindo apenas o horário
				var tr = document.createElement('tr');
				tr.innerHTML = `<td>${operationCount}</td><td>${serverAddress}</td><td>${operation}</td><td>${horario}</td>`;

				// Adiciona evento de clique na linha para abrir o modal de detalhes
				tr.addEventListener('click', function () {
					modalServerAddress.textContent = serverAddress;
					modalOperation.textContent = operation;

					// Define a opção em texto
					var opcaoTexto = '';
					if (mensagem.opcao === 0) {
						opcaoTexto = 'DESLIGAR APARELHO';
					} else if (mensagem.opcao === 1) {
						opcaoTexto = 'LIGAR APARELHO';
					} else if (mensagem.opcao === 2) {
						opcaoTexto = 'DESCREVER APARELHO';
					}

					modalHeaderInfo.textContent = opcaoTexto;
					modalDateInfo.textContent = dataStr; // Exibe a data no modal
					operationModal.show();
				});

				operationsBody.appendChild(tr);

				// Atualiza contagem de operações por servidor
				if (!serverOpCount[serverAddress]) serverOpCount[serverAddress] = 0;
				serverOpCount[serverAddress]++;
				updateChart();
			} catch (err) {
				console.error('Erro ao processar mensagem:', err);
			}
		});
	</script>
</body>

</html>